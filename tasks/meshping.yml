--- # Meshping Ansible Tasks
- name: Install dependencies
  yum:
    name: "{{ item }}"
    state: present
  with_items:
    - mercurial
    - Cython
    - liboping-devel
    - liboping
    - python-flask
    - python-redis
    - python-devel
    - redis
    - gcc

- name: Checkout meshping Bitbucket project
  hg:
    repo: http://bitbucket.org/Svedrin/meshping
    dest: /opt/meshping

- name: Build meshping
  command: chdir=/opt/meshping ./build.sh
  register: result

- name: Create cli symlink
  file:
    src: /opt/meshping/cli.py
    dest: /usr/local/bin/mpcli
    state: link

- name: Ensure meshping.service file
  file:
    path: /etc/systemd/system/meshping.service
    state: touch
    owner: root
    group: root
    mode: 0755

- name: Manage meshping.service content
  blockinfile:
    dest: /etc/systemd/system/meshping.service
    block: |
      [Unit]
      Description=meshping
      After=network.target remote-fs.target nss-lookup.target

      [Service]
      Type=simple
      ExecStart=/usr/bin/python -- /opt/meshping/src/meshping.py

      [Install]
      WantedBy=multi-user.target

- name: Enable meshping service
  systemd:
    daemon_reload: yes
    name: meshping
    enabled: yes
    state: started

- name: Setup ping targets
  command: mpcli -a "{{ item }}"
  with_items:
    - google.com@8.8.8.8
    - router@192.168.0.1
    - eu.battle.net
    - speedtest-lon1.digitalocean.com
    - speedtest-nyc1.digitalocean.com
    - speedtest-sfo1.digitalocean.com
    - speedtest.mybroadband.co.za